{% extends "base.html" %}

{% block title %}Point of Sale - POS System{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-2 text-gray-800">
                <i class="fas bi-cash me-2"></i>Point of Sale
            </h1>
            <p class="mb-0">Pengolahan penjualan cepat dan mudah</p>
        </div>
        <div class="d-flex">
            <span class="badge bg-primary me-3">
                <i class="fas fa-user me-1"></i>{{ current_user.username }}
            </span>
            <span class="badge bg-secondary">
                <i class="fas fa-store me-1"></i>{{ current_user.tenant.name }}
            </span>
        </div>
    </div>

    <div class="row">
        <!-- Products Panel -->
        <div class="col-lg-8">
            <!-- Search and Categories -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-search me-2"></i>Produk
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="productSearch" 
                                   placeholder="Cari produk berdasarkan nama, SKU, atau barcode...">
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="categoryFilter">
                                <option value="">Semua Kategori</option>
                                <!-- Categories will be populated dynamically -->
                            </select>
                        </div>
                    </div>

                   <!-- Products Grid -->
<div class="row" id="productsGrid">
    {% for product in products %}
    <div class="col-xl-3 col-lg-4 col-md-6 mb-3 product-item" 
         data-product-id="{{ product.id }}"
         data-product-name="{{ product.name }}"
         data-product-price="{{ product.price }}"
         data-product-stock="{{ product.stock_quantity }}"
         data-requires-stock="{{ 'true' if product.requires_stock_tracking else 'false' }}"
         data-has-bom="{{ 'true' if product.has_bom else 'false' }}"
         data-is-active="{{ 'true' if product.is_active else 'false' }}"
         data-name="{{ product.name.lower() }}" 
         data-sku="{{ product.sku.lower() }}" 
         data-category="{{ product.category_name.lower() if product.category_name else '' }}">
        <div class="card h-100 product-card {% if not product.is_active %}border-warning{% endif %} 
            {% if product.requires_stock_tracking and product.stock_quantity == 0 %}border-danger{% endif %}">
            <div class="card-body text-center p-3">
                <!-- Product Image -->
                <div class="mb-2">
                    {% if product.image_url %}
                    <img src="{{ product.image_url }}" alt="{{ product.name }}" 
                         class="img-fluid rounded" style="height: 80px; object-fit: cover;">
                    {% else %}
                    <div class="bg-light rounded d-flex align-items-center justify-content-center mx-auto" 
                         style="width: 80px; height: 80px;">
                        <i class="fas fa-cube text-muted fa-2x"></i>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Product Info -->
                <h6 class="card-title mb-1">{{ product.name }}</h6>
                <p class="card-text text-success mb-1">
                    <strong>Rp {{ "{:,.0f}".format(product.price) }}</strong>
                </p>
                
                <!-- Stock Info -->
                <div class="small text-muted mb-2">
                    {% if product.requires_stock_tracking %}
                    Stock: {{ product.stock_quantity }} {{ product.unit }}
                    {% else %}
                    <i class="fas fa-infinity"></i> No stock tracking
                    {% endif %}
                </div>
                
                <!-- Badges -->
                <div class="d-flex justify-content-center flex-wrap gap-1">
                    {% if not product.is_active %}
                    <span class="badge bg-warning">Nonaktif</span>
                    {% endif %}
                    {% if product.requires_stock_tracking and product.stock_quantity == 0 %}
                    <span class="badge bg-danger">Stok Habis</span>
                    {% elif product.requires_stock_tracking and product.stock_quantity <= product.stock_alert %}
                    <span class="badge bg-warning">Stok Rendah</span>
                    {% endif %}
                    {% if product.has_bom %}
                    <span class="badge bg-info">BOM</span>
                    {% endif %}
                    {% if product.category_name %}
                    <span class="badge bg-light text-dark">{{ product.category_name }}</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

                    <!-- No Products Message -->
                    <div id="noProducts" class="text-center py-5" style="display: none;">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">Produk Tidak DItemukan</h4>
                        <p class="text-muted">Coba sesuaikan kriteria pencarian</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cart Panel -->
        <div class="col-lg-4">
            <!-- Current Cart -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-shopping-cart me-2"></i>Current Sale
                    </h6>
                    <span class="badge bg-primary" id="cartCount">0 items</span>
                </div>
                <div class="card-body">
                    <!-- Cart Items -->
                    <div id="cartItems" class="mb-3" style="max-height: 300px; overflow-y: auto;">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-cart-plus fa-2x mb-2"></i>
                            <p>Keranjang kosong<br>Tambah produk untuk mulai penjualan</p>
                        </div>
                    </div>

                    <!-- Cart Summary -->
                    <div class="border-top pt-3">
                        <div class="row mb-2">
                            <div class="col-6">Subtotal:</div>
                            <div class="col-6 text-end" id="cartSubtotal">Rp 0</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6">Pajak:</div>
                            <div class="col-6 text-end" id="cartTax">Rp 0</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6">Diskon:</div>
                            <div class="col-6 text-end text-danger" id="cartDiscount">- Rp 0</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6"><strong>Total:</strong></div>
                            <div class="col-6 text-end"><strong id="cartTotal">Rp 0</strong></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Checkout Form -->
<div class="card shadow">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">
            <i class="fas fa-credit-card me-2"></i>Checkout
        </h6>
    </div>
    <div class="card-body">
        <!-- Customer Selection -->
        <div class="mb-3">
            <label for="customerSelect" class="form-label">Customer</label>
            <select class="form-select" id="customerSelect">
                <option value="">Walk-in Customer</option>
                {% for customer in customers %}
                <option value="{{ customer.id }}">
                    {{ customer.name }} - {{ customer.phone or 'No Phone' }}
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Payment Method -->
        <div class="mb-3">
            <label for="paymentMethod" class="form-label">Metode Pembayaran</label>
            <select class="form-select" id="paymentMethod" onchange="togglePaymentFields()">
                <option value="cash">Tunai</option>
                <option value="card">Kartu Kredit/Debit</option>
                <option value="transfer">Transfer Bank</option>
                <option value="qris">QRIS</option>
                <option value="ewallet">E-Wallet</option>
            </select>
        </div>

        <!-- Cash Payment Fields (Hanya tampil untuk cash) -->
        <div id="cashPaymentFields" style="display: none;">
            <div class="mb-3">
                <label for="cashAmount" class="form-label">Total Dibayar</label>
                <div class="input-group">
                    <span class="input-group-text">Rp</span>
                    <input type="number" class="form-control" id="cashAmount" 
                           value="0" min="0" oninput="calculateChange()">
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Kembalian</label>
                <div class="form-control bg-light">
                    <strong id="changeAmount" class="text-success">Rp 0</strong>
                </div>
            </div>
        </div>

        <!-- Discount -->
        <div class="mb-3">
            <label for="discountAmount" class="form-label">Diskon</label>
            <div class="input-group">
                <span class="input-group-text">Rp</span>
                <input type="number" class="form-control" id="discountAmount" 
                       value="0" min="0" step="1000" onchange="updateCartSummary()">
            </div>
        </div>

        <!-- Tax -->
        <div class="mb-3">
            <label for="taxPercentage" class="form-label">Pajak (%)</label>
            <div class="input-group">
                <input type="number" class="form-control" id="taxPercentage" 
                       value="0" min="0" max="100" step="0.1" onchange="updateCartSummary()">
                <span class="input-group-text">%</span>
            </div>
        </div>

        <!-- Notes -->
        <div class="mb-4">
            <label for="saleNotes" class="form-label">Catatan (Opsional)</label>
            <textarea class="form-control" id="saleNotes" rows="2" 
                      placeholder="Additional notes for this sale..."></textarea>
        </div>

        <!-- Checkout Button - ALWAYS ENABLED WHEN CART HAS ITEMS -->
        <button class="btn btn-success btn-lg w-100" id="checkoutBtn" onclick="processCheckout()">
            <i class="fas fa-check me-2"></i>Proses Pembayaran
        </button>

        <!-- Quick Actions -->
        <div class="d-grid gap-2 mt-3">
            <button class="btn btn-outline-danger" onclick="clearCart()">
                <i class="fas fa-trash me-2"></i>Kosongkan Keranjang
            </button>
            <button class="btn btn-outline-info" onclick="testPrint()">
                <i class="fas fa-print me-2"></i>Tes Cetak
            </button>
        </div>
    </div>
</div>

            <!-- Quick Stats -->
            <div class="card shadow mt-4">
                <div class="card-body text-center">
                    <div class="row">
                        <div class="col-6">
                            <div class="text-primary">
                                <i class="fas fa-cubes fa-2x mb-2"></i>
                                <div class="h5 mb-0">{{ products|length }}</div>
                                <small>Produk</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-success">
                                <i class="fas fa-users fa-2x mb-2"></i>
                                <div class="h5 mb-0">{{ customers|length }}</div>
                                <small>Pelanggan</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Alert Modal -->
<div class="modal fade" id="alertModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="alertModalTitle">Alert</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="alertModalBody">
                <!-- Alert content will be inserted here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- Receipt Modal -->
<div class="modal fade" id="receiptModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Penjualan Selesai</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <i class="fas fa-check-circle text-success fa-4x mb-3"></i>
                <h4 class="text-success">Penjualan Berhasil Selesai!</h4>
                <p class="mb-2">Nomor Struk: <strong id="receiptNumber"></strong></p>
                <p class="mb-3">Total Harga: <strong id="receiptTotal"></strong></p>
                <div class="d-flex justify-content-center gap-2">
                    <button class="btn btn-primary" onclick="printReceipt()">
                        <i class="fas fa-print me-2"></i>Cetak Struk
                    </button>
                    <button class="btn btn-success" onclick="newSale()">
                        <i class="fas fa-plus me-2"></i>Penjualan Baru
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
.product-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.product-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    border-color: #0d6efd;
}

.product-card:active {
    transform: translateY(0);
}

.cart-item {
    padding: 10px;
    border-radius: 5px;
    background: #f8f9fa;
    margin-bottom: 8px;
}

.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
}

#productsGrid {
    max-height: 600px;
    overflow-y: auto;
}

#cartItems {
    max-height: 400px;
    overflow-y: auto;
}

/* Scrollbar styling */
::-webkit-scrollbar {
    width: 6px;
}

::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}
</style>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/qz-tray.js') }}"></script>
<script src="{{ url_for('static', filename='js/qz_printer.js') }}"></script>
<script>
// Global cart array
let cartItems = [];

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializePOS();
});

function initializePOS() {
    console.log('üöÄ POS System Initialized');
    
    // Setup search functionality
    document.getElementById('productSearch').addEventListener('input', filterProducts);
    
    // Load categories for filter
    loadCategories();
    
    // Add click event listeners to all product cards - FIXED VERSION
    document.querySelectorAll('.product-card').forEach(card => {
        card.addEventListener('click', function(e) {
            console.log('üéØ Product card clicked');
            
            // Get the parent product-item element
            const productItem = this.closest('.product-item');
            
            if (!productItem) {
                console.error('‚ùå Product item not found');
                return;
            }
            
            // Get product data from data attributes
            const product = {
                id: productItem.dataset.productId,
                name: productItem.dataset.productName,
                price: parseFloat(productItem.dataset.productPrice),
                stock_quantity: parseInt(productItem.dataset.productStock),
                requires_stock_tracking: productItem.dataset.requiresStock === 'true',
                has_bom: productItem.dataset.hasBom === 'true',
                is_active: productItem.dataset.isActive === 'true'
            };
            
            console.log('üì¶ Product data:', product);
            addToCart(product);
        });
    });
    
    console.log(`‚úÖ ${document.querySelectorAll('.product-card').length} product cards initialized`);
    
    // Initialize payment section
    togglePaymentFields();
}

// Simple add to cart function - FIXED VERSION
function addToCart(product) {
    console.log('üõí Adding to cart:', product);
    
    // Basic validation
    if (!product.is_active) {
        showAlert('Product is inactive and cannot be sold!', 'warning');
        return;
    }
    
    if (product.requires_stock_tracking && product.stock_quantity <= 0) {
        showAlert('Product is out of stock!', 'warning');
        return;
    }
    
    // Check if product already in cart
    const existingIndex = cartItems.findIndex(item => item.product_id === product.id);
    
    if (existingIndex > -1) {
        // Update existing item
        const existingItem = cartItems[existingIndex];
        
        // Check stock limit
        if (product.requires_stock_tracking && existingItem.quantity >= product.stock_quantity) {
            showAlert(`Cannot add more "${product.name}". Only ${product.stock_quantity} available.`, 'warning');
            return;
        }
        
        existingItem.quantity += 1;
        existingItem.total_price = existingItem.quantity * existingItem.unit_price;
        console.log('üìà Updated existing item:', existingItem);
    } else {
        // Add new item
        const newItem = {
            product_id: product.id,
            product_name: product.name,
            quantity: 1,
            unit_price: product.price,
            total_price: product.price,
            requires_stock_tracking: product.requires_stock_tracking,
            has_bom: product.has_bom,
            stock_quantity: product.stock_quantity
        };
        cartItems.push(newItem);
        console.log('üÜï Added new item:', newItem);
    }
    
    updateCartDisplay();
    updateCartSummary();
    showAlert(`"${product.name}" added to cart!`, 'success');
}

// Update cart display
function updateCartDisplay() {
    const cartItemsContainer = document.getElementById('cartItems');
    const cartCount = document.getElementById('cartCount');
    const checkoutBtn = document.getElementById('checkoutBtn');
    
    if (cartItems.length === 0) {
        cartItemsContainer.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-cart-plus fa-2x mb-2"></i>
                <p>Cart is empty<br>Add products to start sale</p>
            </div>
        `;
        cartCount.textContent = '0 items';
        checkoutBtn.disabled = true;
        return;
    }
    
    let cartHTML = '';
    cartItems.forEach((item, index) => {
        cartHTML += `
            <div class="cart-item border-bottom pb-2 mb-2">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <strong class="d-block">${item.product_name}</strong>
                        <small class="text-muted">
                            Rp ${item.unit_price.toLocaleString()} √ó ${item.quantity}
                        </small>
                        <div class="mt-1">
                            ${item.has_bom ? '<span class="badge bg-info me-1">BOM</span>' : ''}
                            ${!item.requires_stock_tracking ? '<span class="badge bg-secondary me-1">No Stock</span>' : ''}
                        </div>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold text-success mb-1">Rp ${item.total_price.toLocaleString()}</div>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary" onclick="updateQuantity(${index}, -1)">
                                <i class="fas fa-minus"></i>
                            </button>
                            <span class="btn btn-outline-light text-dark px-3">${item.quantity}</span>
                            <button class="btn btn-outline-secondary" onclick="updateQuantity(${index}, 1)">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="removeFromCart(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    cartItemsContainer.innerHTML = cartHTML;
    cartCount.textContent = `${cartItems.length} ${cartItems.length === 1 ? 'item' : 'items'}`;
    
    // ALWAYS ENABLE CHECKOUT BUTTON WHEN CART HAS ITEMS
    checkoutBtn.disabled = false;
}

// Update quantity
function updateQuantity(index, change) {
    const item = cartItems[index];
    const newQuantity = item.quantity + change;
    
    if (newQuantity <= 0) {
        removeFromCart(index);
        return;
    }
    
    // Check stock limit
    if (item.requires_stock_tracking && newQuantity > item.stock_quantity) {
        showAlert(`Only ${item.stock_quantity} units available for "${item.product_name}"`, 'warning');
        return;
    }
    
    item.quantity = newQuantity;
    item.total_price = item.quantity * item.unit_price;
    
    updateCartDisplay();
    updateCartSummary();
}

// Remove from cart
function removeFromCart(index) {
    const itemName = cartItems[index].product_name;
    cartItems.splice(index, 1);
    updateCartDisplay();
    updateCartSummary();
    showAlert(`"${itemName}" removed from cart`, 'info');
}

// Update cart summary
function updateCartSummary() {
    const subtotal = cartItems.reduce((sum, item) => sum + item.total_price, 0);
    const discount = parseFloat(document.getElementById('discountAmount').value) || 0;
    const taxPercentage = parseFloat(document.getElementById('taxPercentage').value) || 0;
    
    const taxAmount = (subtotal - discount) * (taxPercentage / 100);
    const total = subtotal - discount + taxAmount;
    
    document.getElementById('cartSubtotal').textContent = `Rp ${subtotal.toLocaleString()}`;
    document.getElementById('cartTax').textContent = `Rp ${taxAmount.toLocaleString()}`;
    document.getElementById('cartDiscount').textContent = `- Rp ${discount.toLocaleString()}`;
    document.getElementById('cartTotal').textContent = `Rp ${total.toLocaleString()}`;
    
    // Update payment section
    updatePaymentSection(total);
}

// Clear cart
function clearCart() {
    cartItems = [];
    updateCartDisplay();
    updateCartSummary();
    showAlert('Cart cleared successfully!', 'info');
}

// Toggle payment fields based on payment method
function togglePaymentFields() {
    const paymentMethod = document.getElementById('paymentMethod').value;
    const cashFields = document.getElementById('cashPaymentFields');
    
    if (paymentMethod === 'cash') {
        cashFields.style.display = 'block';
        // Auto-focus on cash amount input
        setTimeout(() => {
            document.getElementById('cashAmount').focus();
        }, 100);
    } else {
        cashFields.style.display = 'none';
    }
    
    calculateChange();
}

// Calculate change for cash payments
function calculateChange() {
    const total = getCartTotal();
    const cashAmount = parseFloat(document.getElementById('cashAmount').value) || 0;
    const change = cashAmount - total;
    
    const changeElement = document.getElementById('changeAmount');
    
    if (change >= 0) {
        changeElement.textContent = `Rp ${change.toLocaleString()}`;
        changeElement.className = 'text-success';
    } else {
        changeElement.textContent = `-Rp ${Math.abs(change).toLocaleString()}`;
        changeElement.className = 'text-danger';
    }
    
    // Don't disable checkout button based on change - let user decide
}

// Get cart total
function getCartTotal() {
    const subtotal = cartItems.reduce((sum, item) => sum + item.total_price, 0);
    const discount = parseFloat(document.getElementById('discountAmount').value) || 0;
    const taxPercentage = parseFloat(document.getElementById('taxPercentage').value) || 0;
    const taxAmount = (subtotal - discount) * (taxPercentage / 100);
    
    return subtotal - discount + taxAmount;
}

// Update payment section when cart changes
function updatePaymentSection(total) {
    const paymentMethod = document.getElementById('paymentMethod').value;
    
    if (paymentMethod === 'cash') {
        calculateChange();
    }
    
    // ALWAYS KEEP CHECKOUT ENABLED IF CART HAS ITEMS
    const checkoutBtn = document.getElementById('checkoutBtn');
    checkoutBtn.disabled = cartItems.length === 0;
}

// Enhanced checkout process with better error handling
async function processCheckout() {
    if (cartItems.length === 0) {
        showAlert('Cart is empty! Please add products before checkout.', 'warning');
        return;
    }

    const total = getCartTotal();
    const paymentMethod = document.getElementById('paymentMethod').value;
    
    // Show loading
    const checkoutBtn = document.getElementById('checkoutBtn');
    const originalText = checkoutBtn.innerHTML;
    checkoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
    checkoutBtn.disabled = true;

    try {
        // Prepare sale data
        const saleData = {
            items: cartItems,
            total_amount: total,
            tax_amount: parseFloat(document.getElementById('taxPercentage').value) || 0,
            discount_amount: parseFloat(document.getElementById('discountAmount').value) || 0,
            payment_method: paymentMethod,
            customer_id: document.getElementById('customerSelect').value || null,
            notes: document.getElementById('saleNotes').value || '',
            cash_amount: paymentMethod === 'cash' ? parseFloat(document.getElementById('cashAmount').value) : 0,
            change_amount: paymentMethod === 'cash' ? (parseFloat(document.getElementById('cashAmount').value) - total) : 0
        };

        console.log('üì§ Sending sale data:', saleData);

        // Process sale
        const response = await fetch('/sales/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(saleData)
        });

        const result = await response.json();
        console.log('üì• Received response:', result);

        if (result.success) {
            // Prepare receipt data for QZ Tray printing
            const receiptData = {
                store_name: "{{ current_user.tenant.name }}",
                store_address: "{{ current_user.tenant.address or '' }}",
                store_phone: "{{ current_user.tenant.phone or '' }}",
                receipt_number: result.receipt_number,
                date: new Date().toLocaleString('id-ID'),
                cashier: "{{ current_user.username }}",
                items: cartItems.map(item => ({
                    name: item.product_name,
                    quantity: item.quantity,
                    unit_price: item.unit_price,
                    total_price: item.total_price
                })),
                subtotal: getCartSubtotal(),
                tax: saleData.tax_amount,
                discount: saleData.discount_amount,
                grand_total: total,
                payment_method: paymentMethod,
                amount_paid: saleData.cash_amount,
                change: saleData.change_amount,
                customer_name: getSelectedCustomerName()
            };

            // Print receipt automatically
            console.log('üñ®Ô∏è Attempting to print receipt...');
            
            try {
                const printResult = await printReceiptWithQZ(receiptData);
                
                if (printResult.success) {
                    showAlert(`‚úÖ Sale completed and receipt printed!\nReceipt: ${result.receipt_number}`, 'success');
                } else {
                    showAlert(`‚ö†Ô∏è Sale completed but printing failed: ${printResult.message}\nReceipt: ${result.receipt_number}\n\nYou can retry printing from the receipt page.`, 'warning');
                }
            } catch (printError) {
                console.error('Print error:', printError);
                showAlert(`‚úÖ Sale completed but printing failed: ${printError.message}\nReceipt: ${result.receipt_number}`, 'warning');
            }

            // Reset form and clear cart
            clearCart();
            document.getElementById('cashAmount').value = '';
            document.getElementById('discountAmount').value = '0';
            document.getElementById('taxPercentage').value = '0';
            document.getElementById('saleNotes').value = '';
            document.getElementById('customerSelect').value = '';
            
        } else {
            throw new Error(result.error || 'Checkout failed');
        }

    } catch (error) {
        console.error('‚ùå Checkout error:', error);
        showAlert('Error during checkout: ' + error.message, 'error');
    } finally {
        // Reset button
        checkoutBtn.innerHTML = originalText;
        checkoutBtn.disabled = cartItems.length === 0;
    }
}

// Helper function to get cart subtotal
function getCartSubtotal() {
    return cartItems.reduce((sum, item) => sum + item.total_price, 0);
}

// Helper function to get selected customer name
function getSelectedCustomerName() {
    const customerSelect = document.getElementById('customerSelect');
    const selectedOption = customerSelect.options[customerSelect.selectedIndex];
    return selectedOption.text.split(' - ')[0] || '';
}

// Test print function
async function testPrint() {
    console.log('üß™ Testing printer...');
    showAlert('Testing printer...', 'info');
    
    try {
        const result = await printTestPageWithQZ();
        if (result.success) {
            showAlert('‚úÖ Test print successful!', 'success');
        } else {
            showAlert(`‚ùå Test print failed: ${result.message}`, 'error');
        }
    } catch (error) {
        showAlert(`‚ùå Test print error: ${error.message}`, 'error');
    }
}

// Show receipt modal
function showReceiptModal(receiptNumber, totalAmount) {
    document.getElementById('receiptNumber').textContent = receiptNumber;
    document.getElementById('receiptTotal').textContent = `Rp ${totalAmount.toLocaleString()}`;
    
    const receiptModal = new bootstrap.Modal(document.getElementById('receiptModal'));
    receiptModal.show();
}

// Print receipt
function printReceipt() {
    // Implement receipt printing logic here
    const receiptNumber = document.getElementById('receiptNumber').textContent;
    window.open(`/sales/receipt/${receiptNumber}`, '_blank');
}

// Start new sale
function newSale() {
    clearCart();
    document.getElementById('cashAmount').value = '';
    document.getElementById('discountAmount').value = '0';
    document.getElementById('taxPercentage').value = '0';
    document.getElementById('saleNotes').value = '';
    document.getElementById('customerSelect').value = '';
    
    const receiptModal = bootstrap.Modal.getInstance(document.getElementById('receiptModal'));
    receiptModal.hide();
    
    showAlert('New sale started!', 'success');
}

// Alert system
function showAlert(message, type = 'info') {
    // Create toast notification
    const toast = document.createElement('div');
    toast.className = 'position-fixed top-0 end-0 p-3';
    toast.style.zIndex = '9999';
    
    const typeConfig = {
        'success': { bg: 'success', icon: 'check-circle' },
        'error': { bg: 'danger', icon: 'exclamation-triangle' },
        'warning': { bg: 'warning', icon: 'exclamation-triangle' },
        'info': { bg: 'info', icon: 'info-circle' }
    };
    
    const config = typeConfig[type] || typeConfig.info;
    
    toast.innerHTML = `
        <div class="toast show" role="alert">
            <div class="toast-header bg-${config.bg} text-white">
                <i class="fas fa-${config.icon} me-2"></i>
                <strong class="me-auto">${type.charAt(0).toUpperCase() + type.slice(1)}</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // Remove toast after 5 seconds
    setTimeout(() => {
        toast.remove();
    }, 5000);
}

// Search and filter functions
function filterProducts() {
    const searchTerm = document.getElementById('productSearch').value.toLowerCase();
    const categoryFilter = document.getElementById('categoryFilter').value;
    const productItems = document.querySelectorAll('.product-item');
    let visibleCount = 0;

    productItems.forEach(item => {
        const productName = item.dataset.name;
        const productSku = item.dataset.sku;
        const productCategory = item.dataset.category;
        
        const matchesSearch = productName.includes(searchTerm) || productSku.includes(searchTerm);
        const matchesCategory = !categoryFilter || productCategory === categoryFilter;
        
        if (matchesSearch && matchesCategory) {
            item.style.display = 'block';
            visibleCount++;
        } else {
            item.style.display = 'none';
        }
    });

    // Show/hide no products message
    document.getElementById('noProducts').style.display = visibleCount === 0 ? 'block' : 'none';
}

function loadCategories() {
    const categories = new Set();
    document.querySelectorAll('.product-item').forEach(item => {
        if (item.dataset.category) {
            categories.add(item.dataset.category);
        }
    });
    
    const categorySelect = document.getElementById('categoryFilter');
    categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category.charAt(0).toUpperCase() + category.slice(1);
        categorySelect.appendChild(option);
    });
    
    categorySelect.addEventListener('change', filterProducts);
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + K to focus search
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        document.getElementById('productSearch').focus();
    }
    
    // Escape to clear search
    if (e.key === 'Escape') {
        document.getElementById('productSearch').value = '';
        filterProducts();
        document.getElementById('productSearch').blur();
    }
});

// Test function - untuk debugging
function testAddToCart() {
    const testProduct = {
        id: 'test-' + Date.now(),
        name: 'Test Product',
        price: 10000,
        stock_quantity: 10,
        requires_stock_tracking: true,
        has_bom: false,
        is_active: true
    };
    addToCart(testProduct);
}

console.log('üõçÔ∏è Enhanced POS JavaScript loaded successfully');
</script>
{% endblock %}